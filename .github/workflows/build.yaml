name: Build APK

on:
  push:
    branches:
      - development   

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'  # Use the desired Flutter version

    - name: Build APK
      run: |
        flutter pub get
        flutter build apk --debug

    - name: Send APK via Email
      env:
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      run: |
        curl --request POST \
          --url https://api.sendgrid.com/v3/mail/send \
          --header "Authorization: Bearer $SENDGRID_API_KEY" \
          --header "Content-Type: application/json" \
          --data '{
            "personalizations": [
              {
                "to": [
                  {
                    "email": "girisandesh07@gmail.com"   
                  }
                ],
                "subject": "New APK Build"
              }
            ],
            "from": {
              "email": "gsandace@gmail.com"  
            },
            "content": [
              {
                "type": "text/plain",
                "value": "Please find the attached APK."
              }
            ],
            "attachments": [
              {
                "content": "'"$(base64 -w 0 app/build/app/outputs/flutter-apk/app-debug.apk)"'",
                "filename": "app-debug.apk",
                "type": "application/vnd.android.package-archive",
                "disposition": "attachment"
              }
            ]
          }'    